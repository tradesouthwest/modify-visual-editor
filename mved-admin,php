<?php
//Modify Visual Editor
if ( ! defined( 'ABSPATH' ) ) exit; // Exit if accessed directly


//init actions
add_action( 'admin_menu', 'mved_add_admin_menu' );
add_action( 'admin_init', 'mved_settings_init' );


//add a new menu for the admin
// $page_title, $menu_title, $capability, $menu_slug, $function, $icon_url, $position
function mved_add_admin_menu() {

	add_menu_page(
         __( 'Modify Visual Editor', 'mved' ),
         __( 'Modify Visual Ed', 'mved' ),
        'manage_options',
        'modify-visual-editor',
        'mved_options_page'
        );

}

//settings
function mved_settings_init()
{

	register_setting(
        'pluginPage',
        'mved_settings'
    );

	register_setting(
        'pluginPage',
        'mvedASelect',
        'sanitize_textfield'
    );

	add_settings_section(
		'mved_pluginPage_section',
		__( 'Turns On or Off the Visual Editor to disallow using Visual Editor tab.', 'mved' ),
		'mved_settings_section_callback',
		'pluginPage'
	);

	add_settings_field(
		'mved_setting-id',
		'',
		'mved_selection_field_render',
		'pluginPage',
		'mved_pluginPage_section'
	);

    add_option( 'mvedASelect', 'no', '', 'yes'
    );
    add_option( 'mvedBSelect', 'no', '', 'yes'
    );
}

// Query for users based on the meta data

function mved_selection_field_render()
{
    if (isset($_POST['mvedASelect']))
    {

    /**
     * Disable the visual editor for all users
     *
     * Ignores the passed $userID because we're disabling for all users.
     */
    //$user_id, $meta_key, $meta_value

        $mvedASelect       = $_POST['mvedASelect'];
        update_option('mvedASelect', $_POST['mvedASelect']);

        $mvedASelect_key   = 'rich_edting';
        $user_ID           = '';
        $mvedASelect_value = get_option('mvedASelect', '');

        //update user meta field `rich_editing`

        if( $mvedASelect_value == 'no' ) {

        /**
         * Add an action to catch profile updates.
         */
            remove_action('profile_update','mved_update_user_editor_status');
            mved_update_user_editor_status('', 'false');
            add_action('profile_update','mved_update_user_editor_status');

            echo '<div class="updated fade"><p><strong> Editor is OFF <br/> ';
            echo '</strong></p></div>';
            }


            elseif( $mvedASelect_value == 'yes' ) {
                remove_action('profile_update','mved_update_user_editor_status');
                mved_update_user_editor_status('', 'true');
                add_action('profile_update','mved_update_user_editor_status');

            echo '<div class="updated fade"><p><strong> Editor is ON <br/> ';
            echo '</strong></p></div>';
            }

                else {
                echo $mvedASelect_value . ' no_go';
                }
        }

    ?>


            <h2><?php _e('System Settings', 'mved'); ?></h2>
            <table class="table-condensed-options-table"><tbody>
            <tr><td><?php _e('System', 'mved'); ?></td>
                <td><?php echo php_uname(); ?></td></tr>
            <tr><td><?php _e('PHP Version', 'mved'); ?></td>
                <td><?php echo phpversion(); ?>
                <?php
                if (version_compare('5.2', phpversion()) > 0) {
                    echo '&nbsp;&nbsp;&nbsp;<span style="background-color: #ffcc00;">';
                    _e('(WARNING: This plugin may not work properly with versions earlier than PHP 5.2)', 'mved');
                    echo '</span>';
                }
                ?>
                </td>
            </tr>
            <tr><td><?php _e('MySQL Version', 'mved'); ?></td>
                <td><?php echo getMySqlVersion(); ?>
                    <?php
                    echo '&nbsp;&nbsp;&nbsp;<span style="background-color: #ffcc00;">';
                    if (version_compare('5.0', getMySqlVersion()) > 0) {
                        _e('(WARNING: This plugin may not work properly with versions earlier than MySQL 5.0)', 'mved');
                    }
                    echo '</span>';
                    ?>
                </td>
            </tr>
            </tbody></table>

            <h2><?php _e( 'Modify Visual Editor', 'mved' ); ?></h2>

            <form method="post" action="">
            <?php settings_fields('mved_settings'); ?>

            <form name"mved_usermeta_form" method="POST" action="">


                <table class="plugin-options-table"><tbody>
                    <tr valign="top">
                        <td><p><label for="mvedASelect">
                <?php _e( 'Turns On or Off the Visual Editor', 'mved' ); ?>
                        </label></p></td>
                        <td>
                            <p><select name="mvedASelect" id="mvedASelect">
                        <?php
                            $mvedASelect_value = get_option('mvedASelect', 'yes');
                            $isSelected = ' selected="selected"';
                        ?>
                                <option value="yes" <?php if( $mvedASelect_value == 'yes' )
                                echo $isSelected; ?>>ON</option>
                                <option value="no" <?php if( $mvedASelect_value == 'no' )
                                echo $isSelected; ?>>OFF</option>
                            </select></p>
                        </td>
                    </tr>
                    <tr valign="top">
                        <td><p><label for="mvedULevel">
                            <?php _e( 'Choose who has permissions', 'mved' ); ?>
                        <small><?php _e( 'Users above or equal to:', 'mved' ); ?></small>
                            </label></p>
                        </td>
                        <td>
                            <p><select name="mvedULevel" id="mvedULevel">
                            <option value="Administrator" selected>Administrator</option>
                            <option value="Editor" >Editor</option>
                            <option value="Author" >Author</option>
                            <option value="Contributor" >Contributor</option>
                            <option value="Subscriber" >Subscriber</option>
                            <option value="Anyone" >Anyone</option>
                            </select></p>
                        </td>
                        </tr>

                    <tr valign="top">
                        <td><p><label for="mvedBSelect">
                        <?php _e( 'Turns On or Off the Admin Menu Bar', 'mved' ); ?>
                        </label></p></td>
                        <td>
                            <p><select name="mvedBSelect" id="mvedBSelect">
                        <?php
                            $mvedBSelect_value = get_option('mvedBSelect', 'yes');
                            $isSelected = ' selected="selected"';
                        ?>

                                <option value="yes" <?php if( $mvedBSelect_value == 'yes' )
                                echo $isSelected; ?>>ON</option>
                                <option value="no" <?php if( $mvedBSelect_value == 'no' )
                                echo $isSelected; ?>>OFF</option>
                            </select></p>
                        </td>
                    </tr></tbody></table>


<?php
}
?>
<?php

//callback
function mved_settings_section_callback( ) {

echo '<div class="wrap"><p id="tswMved"><img src="' . plugins_url( basename( __DIR__ )) . '/assets/tswlogo.png" alt="TSW=|=" height="32"/> <small>Tradesouthwest =|=</small></p>';

}


//display page
function mved_options_page()
{


		esc_attr( '<h2>Modify Visual Editor</h2>' );


		settings_fields( 'pluginPage' );
		do_settings_sections( 'pluginPage' );

        // create a nonce field
        wp_nonce_field( 'new_mvedASelect_nonce', 'mvedASelect_nonce' );

        submit_button();
        echo '    </p>
            </form>
        </div>';

}

// Hide Admin Bar for All Users Except Adminministrators
function mved_hide_admin_bar() {
    if (!current_user_can('administrator') && !is_admin()) {
        show_admin_bar(false);
    }
}
//add_filter('show_admin_bar', '__return_false'); <-alternative
//add_action('after_setup_theme', 'mved_hide_admin_bar');

    /**
     * @param  $name string name of a database table
     * @return string input prefixed with the WordPress DB table prefix
     * plus the prefix for this plugin
     */
    function prefixTableName($name) {
        global $wpdb;
        return $wpdb->prefix .  strtolower($this->prefix($name));
    }

    /**
     * Query MySQL DB for its version
     * @return string|false
     */
    function getMySqlVersion() {
        global $wpdb;
        $rows = $wpdb->get_results('select version() as mysqlversion');
        if (!empty($rows)) {
             return $rows[0]->mysqlversion;
        }
        return false;
    }




?>
